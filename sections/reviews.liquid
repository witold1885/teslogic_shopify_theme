<link rel="stylesheet" type="text/css" href="{{ 'reviews.css' | asset_url }}">
<link rel="stylesheet" type="text/css" href="{{ 'reviews-responsive.css' | asset_url }}">

{% style %}	
.spr-starrating .spr-icon-star::before {
	content: url({{ 'star-big-filled.svg' | asset_url }});
}
.spr-starrating .spr-icon-star-empty::before {
	content: url({{ 'star-big-outlined.svg' | asset_url }});
}
.spr-starrating .spr-icon-star-hover::before {
	content: url({{ 'star-big-filled.svg' | asset_url }});
}
{% endstyle %}

<!-- <div id="multipleReviews"></div> -->
<div id="reviewsWrap" class="reviews">
	<div class="block_title reviews-title">Reviews</div>
	<div class="reviews-data">
		<div class="reviews-data-left">
			<div class="reviews-rating">
				<div class="reviews-rating-overall">
					<div class="reviews-rating-overall-title">Overall rating</div>
					<div class="reviews-rating-overall-data">
						<div id="totalRatingValue" class="reviews-rating-overall-data-value"></div>
						<div id="totalRatingStars" class="reviews-rating-overall-data-stars"></div>						
					</div>					
				</div>
				<div class="reviews-rating-stats">
					<div id="totalReviewsCount" class="reviews-rating-stats-total"></div>
					<div id="reviewsMarks" class="reviews-rating-stats-marks"></div>
				</div>
			</div>
			<div class="reviews-write">
				<button id="showForm">Write a review</button>
			</div>
		</div>
		<div class="reviews-data-right">
			<div id="multipleReviews" class="reviews-list"></div>
			<div id="pagination" class="spr-pagination reviews-pagination"></div>
			<div id="viewAll" class="reviews-expand">
				<a class="reviews-expand-text">View all reviews</a>
				<img class="reviews-expand-icon" src="{{ 'chevron-down-blue.svg' | asset_url }}">
			</div>
			<div id="showLess" class="reviews-expand">
				<a class="reviews-expand-text">Less reviews</a>
				<img class="reviews-expand-icon reviews-expand-icon-reverted" src="{{ 'chevron-down-blue.svg' | asset_url }}">
			</div>
		</div>
	</div>
</div>

<div class="reviews-form-shadow">
	<div id="reviewsFormWrap" class="reviews-form-wrap">
		<img class="reviews-form-close" src="{{ 'close-grey.png' | asset_url }}">
		<form class="reviews-form">
			
		</form>
	</div>
</div>

{% assign product1 = all_products['teslogic-transmitter-kit'] %}
{% assign product2 = all_products['teslogic-transmitter-kit-v2'] %}
<script>
(function() {
  window.reviewApp = window.reviewApp || {
    debug: false,
    reviews: [],
    reviewUrl: 'https://productreviews.shopifycdn.com/proxy/v4/reviews/',
    reviewStore: {{ shop.permanent_domain | json }},
    /* or hard code the myshopify url - eg: freakdesign.myshopify.com */
  };
  window.reviewApp.translations = {
    'missing_id': 'Product ID array not defined',
    'script_exists': 'The script has already been loaded on the page'
  };
  window.reviewApp.productIdList = [ {{- product1.id -}}, {{ product2.id }} ];
  reviewApp.errLog = function(t) {
    if (!reviewApp.debug) return
    console.warn(reviewApp.translations[t])
  };
  var getBadges = function(a) {
    if (typeof a === 'undefined') {
      errLog('missing_id');
      return
    }
    if (!!document.getElementById('reviewBadges')) {
      errLog('script_exists');
      return
    }
    window.badgesLoaded = function(a) {
      console.log(a);
    };
    var idString = [];
    for (var i = a.length - 1; i >= 0; i--) {
      idString.push('&product_ids[]=' + a[i]);
    };
    var script = document.createElement("script");
    script.id = "reviewBadges";
    script.async = true;
    script.src = [window.reviewApp.reviewUrl, 'badges?callback=badgesLoaded&shop=', window.reviewApp.reviewStore, idString.join('')].join('');
    document.body.appendChild(script);
  };
  window.newReviewRating = 0;
  window.reviewLoaded = function(a) {
    window.reviewApp.reviews.push(a);
    if (window.reviewApp.productIdList.length) {
      reviewApp.getReviews(window.reviewApp.productIdList);
      return;
    };
		var formLoaded = false;
		var reviewCount = 0;
		let ratingMarks = { mark5: 0, mark4: 0, mark3: 0, mark2: 0, mark1: 0 };
		var summaryRatings = [];
    for (var i = window.reviewApp.reviews.length - 1; i >= 0; i--) {
      var tmpDiv = document.createElement('div');
      tmpDiv.innerHTML = window.reviewApp.reviews[i].reviews;
      var reviewText = tmpDiv.querySelectorAll('.spr-review-content');
      var reviewer = tmpDiv.querySelectorAll('.spr-review-header-byline');
      var title = tmpDiv.querySelectorAll('.spr-review-header-title');
      var rating = tmpDiv.querySelectorAll('.spr-starratings');
      // console.log(window.reviewApp.reviews[i].reviews, reviewText.length);
      for (var _i = 0; _i < reviewText.length; _i++) {
        /*var divHtml = '';
        divHtml += ['<div class="product-review"><span class="product-review-title">', title[_i].innerText, '</span><span class="product-review-text">', reviewText[_i].innerText, '</span><span class="product-review-stars">', rating[_i].innerHTML, '</span><span class="product-review-reviewer">', reviewer[_i].innerText, '</span></div>'].join('');*/
        let reviewerArray = reviewer[_i].innerText.split('on')
        let reviewAuthor = reviewerArray[0].trim()
        let reviewDate = reviewerArray[1].trim()
        let reviewHtml = `
        	<div class="reviews-list-item product-review">
        		<div class="reviews-list-item-top">
        			<div class="reviews-list-item-stars product-review-stars">${rating[_i].innerHTML}</div>
        			<div class="reviews-list-item-date">${reviewDate}</div>
        		</div>
        		<div class="reviews-list-item-text product-review-text">${reviewText[_i].innerText}</div>
        		<div class="reviews-list-item-bottom">
        			<div class="reviews-list-item-author">${reviewAuthor}</div>
        		</div>
        	</div>
        `
        document.getElementById('multipleReviews').insertAdjacentHTML('beforeend', reviewHtml);
        let ratingMark = rating[_i].getAttribute('aria-label').split(' ')[0];
        console.log(ratingMark)
		    ratingMarks[`mark${ratingMark}`]++;
      };

      var tmpScriptDiv = document.createElement('div');
      tmpScriptDiv.innerHTML = window.reviewApp.reviews[i].aggregate_rating;
      let aggregateScript = $(tmpScriptDiv).find('script')
			let reviewsJson = $(aggregateScript).text().trim()
			let reviewsData = JSON.parse(reviewsJson)
			console.log(reviewsData)
			reviewCount += Number(reviewsData.reviewCount)

      // console.log(window.reviewApp.reviews[i].product);
      var tmpProductDiv = document.createElement('div');
      tmpProductDiv.innerHTML = window.reviewApp.reviews[i].product;
			let summaryRating = tmpProductDiv.querySelectorAll('span.spr-summary-starrating');
      let summaryMark = summaryRating[0].getAttribute('aria-label').split(' ')[0];
			summaryRatings.push(summaryMark)

			let form = $(tmpProductDiv).find('.spr-form')
			if (!formLoaded) {
				// document.getElementById('reviewsFormWrap').insertAdjacentHTML('beforeend', form.html())
				$('#reviewsFormWrap')
					.find('form')
					.addClass('new-review-form')
					.attr('id', 'new-review-form_8143253733590')
					.attr('method', 'post')
					.attr('action', '//productreviews.shopifycdn.com/api/reviews/create')
					.attr('onsubmit', 'SPR.submitForm(this);return false;')
				let formHtml = `						
	        <input type="hidden" name="review[rating]">
	        <input type="hidden" name="product_id" value="8143253733590">
	        <input id="review_title_8143253733590" class="review-form-title" type="hidden" name="review[title]" value="">
	        <h3 class="spr-form-title">Write a review</h3>
	        <div class="reviews-form-body">
	        	<div class="reviews-form-column">
		        	<div class="reviews-form-field spr-form-contact-name">
                <label class="spr-form-label" for="review_author_8143253733590">Name</label>
                <input class="spr-form-input spr-form-input-text " id="review_author_8143253733590" type="text" name="review[author]" value="" placeholder="Enter your name">
		        	</div>
	        		<div class="reviews-form-field spr-form-contact-email">
                <label class="spr-form-label" for="review_email_8143253733590">Email</label>
                <input class="spr-form-input spr-form-input-email " id="review_email_8143253733590" type="email" name="review[email]" value="" placeholder="john.smith@example.com">
		        	</div>
	        		<div class="reviews-form-field spr-form-review-rating">
                <label class="spr-form-label" for="review[rating]">Rating</label>
                <div class="spr-form-input spr-starrating ">
                  <a href="#" onclick="SPR.setRating(this);return false;" class="spr-icon spr-icon-star spr-icon-star-empty" data-value="1" aria-label="1 of 5 stars">&nbsp;</a>
                  <a href="#" onclick="SPR.setRating(this);return false;" class="spr-icon spr-icon-star spr-icon-star-empty" data-value="2" aria-label="2 of 5 stars">&nbsp;</a>
                  <a href="#" onclick="SPR.setRating(this);return false;" class="spr-icon spr-icon-star spr-icon-star-empty" data-value="3" aria-label="3 of 5 stars">&nbsp;</a>
                  <a href="#" onclick="SPR.setRating(this);return false;" class="spr-icon spr-icon-star spr-icon-star-empty" data-value="4" aria-label="4 of 5 stars">&nbsp;</a>
                  <a href="#" onclick="SPR.setRating(this);return false;" class="spr-icon spr-icon-star spr-icon-star-empty" data-value="5" aria-label="5 of 5 stars">&nbsp;</a>
                </div>
		        	</div>
	        	</div>
	        	<div class="reviews-form-column">
		        	<div class="reviews-form-field spr-form-review-body">
                <label class="spr-form-label" for="review_body_8143253733590">
                  Body of Review
                  <span role="status" aria-live="polite" aria-atomic="true">
                    <span class="spr-form-review-body-charactersremaining">(1500)</span>
                    <span class="visuallyhidden">characters remaining</span>
                  </span>
                </label>
                <div class="spr-form-input">
                   <textarea class="spr-form-input spr-form-input-textarea " id="review_body_8143253733590" data-product-id="8143253733590" name="review[body]" rows="10" placeholder="Write your comments here"></textarea>
                </div>
		        	</div>
	        	</div>
	        </div>
	        <div class="reviews-form-actions">
              	<input type="submit" class="spr-button spr-button-primary button button-primary btn btn-primary" value="Submit Review">
	        </div>
				`
				$('#reviewsFormWrap').find('form').html(formHtml)
				$('#reviewsFormWrap').find('form').find('.spr-form-review-body').find('.spr-form-label').text('Review')
				$('#reviewsFormWrap').find('form').find('.reviews-form-actions').find('.spr-button').val('Submit')
				formLoaded = true
			}
    };

    let sumRatings = 0;
    for (let item of summaryRatings) {
    	sumRatings += Number(item);
    }
    let summaryRating = sumRatings / summaryRatings.length;
    console.log(summaryRating)
    // document.getElementById('totalRatingValue').innerText = Number(reviewsData.ratingValue).toFixed(2);
    let summaryRatingHtml = `
    	<span class="spr-starrating spr-summary-starrating" aria-label="5.0 of 5 stars" role="img">
        <i class="spr-icon spr-icon-star" aria-hidden="true"></i><i class="spr-icon spr-icon-star" aria-hidden="true"></i><i class="spr-icon spr-icon-star" aria-hidden="true"></i><i class="spr-icon spr-icon-star" aria-hidden="true"></i><i class="spr-icon spr-icon-star" aria-hidden="true"></i>
      </span>
    `
    document.getElementById('totalRatingStars').insertAdjacentHTML('beforeend', $(summaryRating).html());

		document.getElementById('totalReviewsCount').insertAdjacentHTML('beforeend', `${reviewCount} reviews`);

    let sumMarks = 0
    for (const mark in ratingMarks) {
    	sumMarks += ratingMarks[mark]
    }
	  if (sumMarks == reviewCount) {
      let marksHtml = '';
      for (let m = 5; m >= 1; m--) {
      	let fillPercent = ratingMarks[`mark${m}`] / reviewCount * 100;
      	marksHtml += `
      		<div class="reviews-rating-stats-mark">
      			<div class="reviews-rating-stats-mark-star">
      				<div class="reviews-rating-stats-mark-star-value">${m}</div>
      				<img class="reviews-rating-stats-mark-star-icon" src="{{ 'star-fill.svg' | asset_url }}">
      				<div class="reviews-rating-stats-mark-star-line">
      					<div class="reviews-rating-stats-mark-star-line-fill" style="width: ${fillPercent}%">
      					</div>
      				</div>
      			</div>
      			<div class="reviews-rating-stats-mark-count">${ratingMarks[`mark${m}`]}</div>
      		</div>
      	`;
      }
      document.getElementById('reviewsMarks').insertAdjacentHTML('beforeend', marksHtml);
	  }
  };
  window.reviewApp.getReviews = function(a) {
    if (typeof a === 'undefined') {
      errLog('missing_id');
      return
    }
    var productId = a.shift();
    var script = document.createElement("script");
    if (document.getElementById('singleReviewData')) {
      document.getElementById('singleReviewData').remove(); /* cleanup (optional) */
    }
    script.id = 'singleReviewData';
    script.async = true;
    script.src = [window.reviewApp.reviewUrl, 'product?callback=reviewLoaded&shop=', window.reviewApp.reviewStore, '&product_id=', productId].join('');
    document.body.appendChild(script);
  };
  reviewApp.getReviews(window.reviewApp.productIdList);

	$('#showForm').on('click', function() {
		$('.new-review-form').css('display', 'block')
		$('.reviews-form-shadow').css('display', 'flex')
	})
	$('.reviews-form-close').on('click', function() {
		$('.reviews-form-shadow').css('display', 'none')
	})
	
	$(document).on('click', '.spr-form-review-rating a.spr-icon-star', function(e) {
		window.newReviewRating = $(this).data('value')
	})

	$(document).on('click', '.reviews-form-actions .spr-button', function(e) {
		e.preventDefault()
		let form = $(this).parents('.new-review-form')
		let author = $(form).find('.spr-form-contact-name').find('.spr-form-input').val()
		if (author == '') {
			$(form)
				.find('.spr-form-contact-name')
				.find('.spr-form-input')
				.css('border', '1px solid red')
			return
		}
		let email = $(form).find('.spr-form-contact-email').find('.spr-form-input').val()
		if (email == '') {
			$(form)
				.find('.spr-form-contact-email')
				.find('.spr-form-input')
				.css('border', '1px solid red')
			return
		}
		let reviewTitle = 'Review of ' + author
		$(form).find('.review-form-title').val(reviewTitle)
		// $(form).submit()
    let formArray = $(form).serializeArray()
    // let formData = { shop: '8cc6c3.myshopify.com' }
    let formData = { shop: 'teslogic.myshopify.com' }
    for (let item of formArray) {
    	formData[item.name] = item.value
    }

    if (!formData['review[rating]']) {
    	formData['review[rating]'] = window.newReviewRating
    }

    $.ajax({
      type: "POST",
      url: 'https://productreviews.shopifycdn.com/proxy/v4/reviews/create',
      data: formData,
      dataType: "json",
      encode: true,
    }).done(function (data) {
      console.log(data);
      if (data.status == 'success') {
      	$('.reviews-form-shadow').css('display', 'none')
      	alert('Your review was added successfully')
      }
      else {
      	alert('Error adding review')
      }
    });
	})
})();
</script>
